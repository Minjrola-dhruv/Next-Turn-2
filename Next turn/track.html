<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Track Your Queue - Next Turn</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .track-container {
      max-width: 700px;
      margin: 60px auto;
      padding: 40px;
    }

    .track-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
    }

    .status-header {
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border-radius: 15px;
      color: white;
      margin-bottom: 30px;
    }

    .status-header.waiting {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .status-header.called {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .status-header.completed {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
    }

    .token-big {
      font-size: 64px;
      font-weight: 900;
      margin: 20px 0;
      text-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .status-badge {
      display: inline-block;
      padding: 10px 20px;
      border-radius: 25px;
      background: rgba(255,255,255,0.3);
      font-weight: 700;
      font-size: 16px;
      margin-top: 10px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 30px 0;
    }

    .info-card {
      background: linear-gradient(135deg, #f8fafc, #f1f5f9);
      padding: 25px;
      border-radius: 15px;
      border-left: 4px solid #3b82f6;
    }

    .info-card.priority {
      border-left-color: #f59e0b;
    }

    .info-label {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 8px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .info-value {
      font-size: 28px;
      font-weight: 900;
      color: #0f172a;
    }

    .progress-section {
      margin: 30px 0;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e2e8f0;
      border-radius: 10px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      transition: width 0.5s ease;
      border-radius: 10px;
    }

    .progress-text {
      text-align: center;
      color: #64748b;
      font-size: 14px;
      margin-top: 10px;
    }

    .message-box {
      background: linear-gradient(135deg, #dbeafe, #eff6ff);
      border-left: 4px solid #3b82f6;
      padding: 20px;
      border-radius: 12px;
      margin: 25px 0;
    }

    .message-box.alert {
      background: linear-gradient(135deg, #fef3c7, #fef9c3);
      border-left-color: #f59e0b;
    }

    .message-box.success {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      border-left-color: #10b981;
    }

    .refresh-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 20px;
    }

    .refresh-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59,130,246,0.3);
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
    }

    .no-data h2 {
      color: #64748b;
      margin-bottom: 20px;
    }

    .join-btn {
      display: inline-block;
      padding: 14px 30px;
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 700;
      transition: all 0.3s;
    }

    .join-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(59,130,246,0.3);
    }

    .people-ahead {
      text-align: center;
      margin: 30px 0;
    }

    .people-count {
      font-size: 72px;
      font-weight: 900;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1;
    }

    .people-label {
      font-size: 16px;
      color: #64748b;
      margin-top: 10px;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading {
      animation: pulse 1.5s ease-in-out infinite;
    }
  </style>
</head>
<body>

<div class="track-container">
  <div class="track-card">
    <div id="loadingState" class="loading">
      <p style="text-align: center; color: #64748b;">Loading queue status...</p>
    </div>

    <div id="queueStatus" style="display: none;">
      <div id="statusHeader" class="status-header">
        <p style="font-size: 14px; opacity: 0.9;" id="placeName">-</p>
        <div class="token-big" id="tokenDisplay">-</div>
        <div class="status-badge" id="statusBadge">-</div>
      </div>

      <div id="waitingContent">
        <div class="people-ahead">
          <div class="people-count" id="peopleAheadCount">-</div>
          <div class="people-label">People ahead of you</div>
        </div>

        <div class="progress-section">
          <p style="font-weight: 700; margin-bottom: 10px;">Queue Progress</p>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <p class="progress-text" id="progressText">-</p>
        </div>

        <div class="info-grid">
          <div class="info-card">
            <div class="info-label">Position</div>
            <div class="info-value" id="position">-</div>
          </div>
          <div class="info-card">
            <div class="info-label">Est. Wait Time</div>
            <div class="info-value" id="waitTime">-</div>
          </div>
          <div class="info-card priority">
            <div class="info-label">Priority</div>
            <div class="info-value" style="font-size: 20px;" id="priority">-</div>
          </div>
          <div class="info-card">
            <div class="info-label">Joined At</div>
            <div class="info-value" style="font-size: 16px;" id="joinedTime">-</div>
          </div>
        </div>

        <div class="message-box" id="messageBox">
          <p style="margin: 0; font-weight: 600;" id="messageText">-</p>
        </div>
      </div>

      <div id="calledContent" style="display: none;">
        <div class="message-box success">
          <h2 style="margin: 0 0 10px 0;">üéâ It's Your Turn!</h2>
          <p style="margin: 0; font-size: 16px;">Please proceed to the counter immediately.</p>
        </div>
      </div>

      <div id="completedContent" style="display: none;">
        <div class="message-box success">
          <h2 style="margin: 0 0 10px 0;">‚úÖ Service Completed</h2>
          <p style="margin: 0;">Thank you for using Next Turn! We hope you had a great experience.</p>
        </div>
      </div>

      <button class="refresh-btn" onclick="refreshStatus()">üîÑ Refresh Status</button>
    </div>

    <div id="noData" class="no-data" style="display: none;">
      <h2>No Active Queue Found</h2>
      <p style="color: #64748b; margin-bottom: 30px;">
        You don't have any active queue status. Scan a QR code to join a queue.
      </p>
      <a href="index.html" class="join-btn">üè† Go to Home</a>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script src="firebase-config.js"></script>

<script>
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let tokenData = null;
let queueListener = null;

// Load token from localStorage
const storedToken = localStorage.getItem('lastToken');
if (storedToken) {
  tokenData = JSON.parse(storedToken);
  loadQueueStatus();
} else {
  showNoData();
}

/**
 * Load and listen to queue status
 */
function loadQueueStatus() {
  if (!tokenData) {
    showNoData();
    return;
  }

  // Listen to queue updates
  const queueRef = db.ref(`queues/${tokenData.placeId}/${tokenData.queueId}`);
  
  queueListener = queueRef.on('value', snapshot => {
    const queueData = snapshot.val();
    
    if (!queueData) {
      showNoData();
      return;
    }

    updateDisplay(queueData);
  });

  // Also get all queue data to calculate position
  db.ref(`queues/${tokenData.placeId}`).on('value', snapshot => {
    const allQueue = snapshot.val() || {};
    const currentQueue = allQueue[tokenData.queueId];
    
    if (currentQueue) {
      const waiting = Object.values(allQueue)
        .filter(q => q.status === 'waiting' && q.position < currentQueue.position)
        .length;
      
      updatePeopleAhead(waiting, currentQueue);
    }
  });
}

/**
 * Update display with queue data
 */
function updateDisplay(queueData) {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('queueStatus').style.display = 'block';
  
  document.getElementById('tokenDisplay').textContent = queueData.token;
  document.getElementById('placeName').textContent = tokenData.placeName || queueData.placeName;
  document.getElementById('position').textContent = '#' + queueData.position;
  document.getElementById('waitTime').textContent = (queueData.estimatedTime || 0) + ' min';
  document.getElementById('priority').textContent = formatPriority(queueData.priorityType);
  document.getElementById('joinedTime').textContent = formatTime(queueData.createdAt);

  // Update status
  const statusHeader = document.getElementById('statusHeader');
  const statusBadge = document.getElementById('statusBadge');
  
  statusHeader.className = 'status-header ' + queueData.status;
  statusBadge.textContent = queueData.status.toUpperCase();

  // Show appropriate content
  document.getElementById('waitingContent').style.display = 'none';
  document.getElementById('calledContent').style.display = 'none';
  document.getElementById('completedContent').style.display = 'none';

  if (queueData.status === 'waiting') {
    document.getElementById('waitingContent').style.display = 'block';
  } else if (queueData.status === 'called') {
    document.getElementById('calledContent').style.display = 'block';
    // Show notification
    if (Notification.permission === 'granted') {
      new Notification('Your Turn!', {
        body: `Token ${queueData.token} - Please proceed to the counter`,
        icon: 'Images/ChatGPT Image Jan 3, 2026, 06_27_04 PM.png'
      });
    }
  } else if (queueData.status === 'completed') {
    document.getElementById('completedContent').style.display = 'block';
  }
}

/**
 * Update people ahead counter
 */
function updatePeopleAhead(count, queueData) {
  const totalWaiting = count;
  const currentPosition = queueData.position;
  
  document.getElementById('peopleAheadCount').textContent = count;
  
  // Update progress bar
  const progress = Math.max(0, Math.min(100, ((currentPosition - count) / currentPosition) * 100));
  document.getElementById('progressFill').style.width = progress + '%';
  document.getElementById('progressText').textContent = 
    `${Math.round(progress)}% through the queue`;

  // Update message
  const messageBox = document.getElementById('messageBox');
  const messageText = document.getElementById('messageText');
  
  if (count === 0) {
    messageBox.className = 'message-box alert';
    messageText.textContent = '‚ö†Ô∏è You\'re next! Please be ready.';
  } else if (count <= 2) {
    messageBox.className = 'message-box alert';
    messageText.textContent = '‚ö†Ô∏è Your turn is coming up soon! Stay nearby.';
  } else if (count <= 5) {
    messageBox.className = 'message-box';
    messageText.textContent = '‚ÑπÔ∏è Please stay in the vicinity. Your turn is approaching.';
  } else {
    messageBox.className = 'message-box';
    messageText.textContent = '‚ÑπÔ∏è You can relax for now. We\'ll update you as the queue moves.';
  }
}

/**
 * Refresh status
 */
function refreshStatus() {
  if (tokenData) {
    loadQueueStatus();
  }
}

/**
 * Show no data state
 */
function showNoData() {
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('queueStatus').style.display = 'none';
  document.getElementById('noData').style.display = 'block';
}

/**
 * Helper functions
 */
function formatPriority(priority) {
  const map = {
    normal: 'üë§ Normal',
    child: 'üë∂ Child',
    elderly: 'üë¥ Elderly',
    pregnant: 'ü§∞ Pregnant'
  };
  return map[priority] || priority;
}

function formatTime(timestamp) {
  const date = new Date(timestamp);
  return date.toLocaleTimeString('en-US', { 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: true 
  });
}

// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
  Notification.requestPermission();
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
  if (queueListener) {
    db.ref(`queues/${tokenData.placeId}/${tokenData.queueId}`).off('value', queueListener);
  }
});
</script>

</body>
</html>
